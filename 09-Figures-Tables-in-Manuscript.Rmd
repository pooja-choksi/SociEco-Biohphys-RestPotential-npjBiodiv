---
title: "People-centric restoration: Figures and tables in manuscript"
author: "Pooja Choksi"
date: '2022-06-27'
output: html_document
---

In this script, we use the district level land use, multidimensional poverty, climate vulnerability and population data along with new sources of data for question 4 of this study.  


```{r setup, include=FALSE}
library(ggplot2)
library(forcats)
library(dplyr)
library(qcc)
library(gridExtra)
library(viridis)
#get color blind friendly colors 
library(pals)
library(rgdal)

```


Read in all the data from previous scripts that we need for plots and tables.

```{r message = FALSE, warning=FALSE, include=TRUE}

#For all questions, we need this data
districts_info = read.csv("District-Climate-MPI-Biophys-Ranked.csv")

#list of aspirational districts from Phase 1
aspirational_districts = read.csv("Aspirational-Districts-Phase1.csv")

#district shapefile with info on the people-centric variables
districts = readOGR("C:\\Users\\pooja\\Documents\\GitHub\\Land-Tenure-Restoration-Potential\\Land-Tenure-Restoration-Potential\\Census2011-District-Shapefiles\\District-MPI-Climate-Pop-Merged-Biophys.shp")

```

#COMBINE ASPIRATIONAL DISTRICTS TO DISTRICTS_INFO

```{r message=FALSE, warning=FALSE, include=TRUE}

#Make a variable for the presence of aspirational district
aspirational_districts$Aspirational_District = "Aspirational_district"

#recode districts to match with the main dataset 
aspirational_districts = aspirational_districts%>%dplyr::mutate(District.name = recode(District.name, 
"West singhbhum" ="Pashchimi Singhbhum", 
"Chatttarpur" = "Chhatarpur",
"East nimar" = "East Nimar",
"Gadchiroli" = "Garhchiroli",
"Nuapara" = "Nuapada",
"Ferozepur" = "Firozpur",
"Dholpur" = "Dhaulpur",
"Virudhunagar" = "Virudunagar",
"Haridwar" = "Hardwar",
"Udham singh nagar" = "Udham Singh Nagar",
"Dakshin dinajpur" = "Dakshin Dinajpur"))

#combine with districts_info

#Combine aspiration districts with the main dataset
districts_info = merge(districts_info, aspirational_districts[c("District.name", "S.NO.", "Aspirational_District")], by.x = c("NAME_2", "NAME_1"), 
              by.y =c("District.name", "S.NO."), all.x=T)

```

## SYNERGIES AND TRADE-OFFS BETWEEN SEVERAL FACTORS

The chunk of code below creates a scatterplot where each district's biophysical potential and people-centric restoration opportunity scale is plotted. 

```{r message=FALSE, warning=FALSE, include=TRUE, echo= FALSE}
#All the land tenures together
#first categorize the three variables

#Remove the duplicates 
districts_info = districts_info [!duplicated(districts_info[c("NAME_1","NAME_2")]),]

districts_info$tenure_max  = apply(districts_info[c("Tt_C_", "Tt_I_", "Tt_F_")], 1, max)

districts_info = districts_info%>%mutate(tenure_max_cat = 
 case_when(tenure_max == Tt_I_ ~ "Individual",
           tenure_max == Tt_C_ ~ "Common",
           tenure_max == Tt_F_ ~ "Forest", 
           TRUE ~ "NA"))

biophys_people_scale1 = ggplot(districts_info) + geom_jitter(data= districts_info, aes(x = strass_rank, y= P_C_R, shape = tenure_max_cat, color = Clmt_vlnrb, size = Lvng_), alpha = 0.6)+
theme_bw()+scale_color_viridis(option = "D")+
  scale_y_continuous(name = "District rank according to people-centric restoration opportunity") + scale_x_continuous(name="District rank according to biophysical restoration potential")+ 
   geom_vline(xintercept =274, linetype="dashed") + geom_hline(yintercept = 275, linetype="dashed")+ labs(color = "Climate Vulnerability", size = "Poverty %", shape = "Dominant tenure regime")+expand_limits(y = 555) 

#alternative plot
biophys_people_scale2 = ggplot(districts_info) + geom_jitter(data= districts_info, aes(x = Strassburg_Scaled_final, y= Pp__M, shape = tenure_max_cat, color = Clmt_vlnrb, size = Lvng_), alpha = 0.6)+theme_bw()+scale_color_viridis(option = "D")+ scale_y_continuous(name = "People-centric restoration opportunity")+ scale_x_continuous(name="Biophysical restoration potential")+ geom_vline(xintercept =0.5, linetype="dashed") + geom_hline(yintercept = 0.5, linetype="dashed")+ labs(color = "Climate Vulnerability", size = "Poverty %", shape = "Dominant tenure regime")

#climate vulnerability v/s biophysical potential 
biophys_people_scale2 = ggplot(districts_info) + geom_jitter(data= districts_info, aes(x = Strassburg_Scaled_final, y= Clmt_vln_1, shape = tenure_max_cat, color = Clmt_vln_1, size = 3), alpha = 0.6)+theme_bw()+scale_color_viridis(option = "D")+ scale_y_continuous(name = "Climate vulnerability")+ scale_x_continuous(name="Biophysical restoration potential")+ geom_vline(xintercept =0.5, linetype="dashed") + geom_hline(yintercept = 0.5, linetype="dashed")+ labs(color = "Climate Vulnerability", shape = "Dominant tenure regime")

biophys_people_scale2

#climate vulnerability v/s biophysical potential 
biophys_people_scale3 = ggplot(districts_info) + geom_jitter(data= districts_info, aes(x = Strassburg_Scaled_final, y= Lvn__, shape = tenure_max_cat, color = Lvn__, size = 3), alpha = 0.6)+theme_bw()+scale_color_viridis(option = "D")+ scale_y_continuous(name = "Poverty (Living standards)")+ scale_x_continuous(name="Biophysical restoration potential")+ geom_vline(xintercept =0.5, linetype="dashed") + geom_hline(yintercept = 0.5, linetype="dashed")+ labs(color = "Poverty", shape = "Dominant tenure regime")

biophys_people_scale3

```

#TABLE OF THE AGREEMENT WITHIN DISTRICTS PERCENTILES 

This table shows what the exact cut offs for the percentiles are and how many districts there are in common using the percentiles for the people-centric scale and biophysical scale

```{r}
#Percentiles for people-centric scale 
quantile(districts_info$Pp__M,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(People_Percentile = case_when(Pp__M <=0.4445172 ~"0-10",
Pp__M<=0.5135141~ "10-20",
Pp__M<=0.5573356 ~"20-30",
Pp__M<=0.6001708~ "30-40",
Pp__M<=0.6317055~ "40-50",
Pp__M<=0.6610663 ~ "50-60",
Pp__M<=0.6912787 ~ "60-70",
Pp__M<=0.7253923 ~ "70-80",
Pp__M<=0.7628635 ~ "80-90",
Pp__M<=0.9506494 ~ "90-100",
TRUE ~ "NA"))

#define the levels to plot 
levels(districts_info$People_Percentile) = c("0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100")

#Percentiles for living standards of MPI 
quantile(districts_info$Lvn__,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(Poverty_Percentile = case_when(
Lvn__<=0.4620779 ~ "0-10",
Lvn__<=0.5870130 ~ "10-20",
Lvn__<=0.6389610 ~"20-30",
Lvn__<=0.6727273~ "30-40",
Lvn__<=0.7116883~ "40-50",
Lvn__<=0.7361039 ~ "50-60",
Lvn__<=0.7696104 ~ "60-70",
Lvn__<=0.8000000 ~ "70-80",
Lvn__<=0.8522078 ~ "80-90",
Lvn__<=1.0000000 ~ "90-100",
TRUE ~ "NA"))

#define the levels to plot 
levels(districts_info$Poverty_Percentile) =c("0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100")

#Percentiles for climate vulnerability
quantile(districts_info$Clmt_vln_1,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(Climate_Vul_Percentile = case_when(Clmt_vln_1<=0.3447433 ~ "0-10",
Clmt_vln_1<=0.4058680 ~ "10-20",
Clmt_vln_1<=0.4523227 ~"20-30",
Clmt_vln_1<=0.5012225~ "30-40",
Clmt_vln_1<=0.5550122~ "40-50",
Clmt_vln_1<=0.5941320 ~ "50-60",
Clmt_vln_1<=0.6413203 ~ "60-70",
Clmt_vln_1<=0.6894866 ~ "70-80",
Clmt_vln_1<=0.7579462 ~ "80-90",
Clmt_vln_1<=1.0000000 ~ "90-100",
TRUE ~ "NA"))

#define the levels to plot 
levels(districts_info$Climate_Vul_Percentile) = c("0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100")

#Percentiles for Strassburg dataset
quantile(districts_info$Strassburg_Scaled_final,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(Strassburg_Percentile = case_when(Strassburg_Scaled_final<=0.44012024 ~ "0-10",
Strassburg_Scaled_final<=0.55204775 ~ "10-20",
Strassburg_Scaled_final<=0.65949414 ~"20-30",
Strassburg_Scaled_final<=0.70312745~ "30-40",
Strassburg_Scaled_final<=0.74401004~ "40-50",
Strassburg_Scaled_final<=0.77339286 ~ "50-60",
Strassburg_Scaled_final<=0.80372271 ~ "60-70",
Strassburg_Scaled_final<=0.83253145 ~ "70-80",
Strassburg_Scaled_final<=0.86876068 ~ "80-90",
Strassburg_Scaled_final<=0.95653409 ~ "90-100",
TRUE ~ "NA"))

#define the levels to plot 
levels(districts_info$Strassburg_Percentile) = c("0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100")

#Find districts with agreement 
districts_info$People_Strassburg_Percent_Match = ifelse(districts_info$People_Percentile == districts_info$Strassburg_Percentile, "Agreement", "No agreement")

#create a column to show which percentile the agreement and disagreement 
districts_info = districts_info%>%mutate(People_Strassburg_Percentile_Matched= case_when(districts_info$People_Strassburg_Percent_Match == "Agreement" ~ districts_info$People_Percentile, TRUE ~ "No agreement"))

#Find districts with agreement 
districts_info$Poverty_Strassburg_Percent_Match = ifelse(districts_info$Poverty_Percentile == districts_info$Strassburg_Percentile, "Agreement", "No agreement")

#create a column to show which percentile the agreement and disagreement 
districts_info = districts_info%>%mutate(Poverty_Strassburg_Percentile_Matched= case_when(districts_info$Poverty_Strassburg_Percent_Match == "Agreement" ~ districts_info$Poverty_Percentile, TRUE ~ "No agreement"))

#Find districts with agreement 
districts_info$Climate_Strassburg_Percent_Match = ifelse(districts_info$Climate_Vul_Percentile == districts_info$Strassburg_Percentile, "Agreement", "No agreement")

#create a column to show which percentile the agreement and disagreement 
districts_info = districts_info%>%mutate(Climate_Strassburg_Percentile_Matched= case_when(districts_info$Climate_Strassburg_Percent_Match == "Agreement" ~ districts_info$Climate_Vul_Percentile, TRUE ~ "No agreement"))

#1. People-centric and Strassburg agreement percentiles 
agreement = districts_info%>%filter(People_Strassburg_Percent_Match == "Agreement")

#Table of agreement districts using Strassburg and People-centric scale 
agreement_districts_table = agreement%>%dplyr::group_by(People_Percentile)%>%dplyr::mutate(Number_districts_in_agreement= n())

agreement_districts_table = agreement_districts_table%>%

levels(agreement_districts_table$People_Percentile) = c("Percentile 10", "Percentile 29", "Percentile 8", "Percentile 7", "Percentile 6", "Percentile 5", "Percentile 4", "Percentile 3", "Percentile 2", "Percentile 1")


```

#REPORT THE DISTRICTS IN THE TOP AND BOTTOM PERCENTILES AND QUANTILES 
```{r message = FALSE, warning=FALSE, include =TRUE}

#top percentile (higher percentile is higher priority)
percentile_1 = districts_info%>%filter(People_Percentile == "Percentile 1")

#top percentile of poverty 
poverty_percentile_1 = districts_info%>%filter(Poverty_Percentile == "Percentile 1")

#top percentile of climate vulnerability
climate_percentile_1 = districts_info%>%filter(Climate_Vul_Percentile == "Percentile 1")

```

#PLOT OF PROPORTION OF LAND TENURES WITHIN THE AGREEMENT DISTRICTS

Within districts which have agreement across percentiles, this plot shows the distribution of land tenure

```{r message=FALSE, warning=FALSE, include=TRUE}
#Filter out the agreement districts 

#1. People-centric and Strassburg agreement percentiles 
agreement = districts_info%>%filter(People_Strassburg_Percent_Match == "Agreement")

agreement$People_Percentile = as.factor(agreement$People_Percentile)

options(scipen = 999)

#Proportion of land available in each land tenure
agreement_plot = agreement%>%dplyr::group_by(People_Percentile)%>%
  dplyr::summarise(total = n(),
                   total_indiv = sum(Tt_I_), 
                   total_forest = sum(Tt_F_),
                   total_unaccounted = sum(Tt_U_),
                   total_common = sum(Tt_C_))

agreement_plot = agreement_plot%>%mutate(Prop_Indiv = (total_indiv/(total_indiv+total_common+total_forest+total_unaccounted))*100,

Prop_Common = (total_common/(total_indiv+total_common+total_forest+total_unaccounted))*100,

Prop_Unaccounted =(total_unaccounted/(total_indiv+total_common+total_forest+total_unaccounted))*100,

Prop_Forest = (total_forest/(total_indiv+total_common+total_forest+total_unaccounted))*100)

#reshape data for plotting
install.packages("reshape2")
library(reshape2)

agreement_plot_long = agreement_plot[, -c(2:6)]
agreement_plot_long = reshape2::melt(agreement_plot_long, id.vars = "People_Percentile")

#define the levels to plot 
levels(agreement_plot_long$People_Percentile) = c("Percentile 1", "Percentile 2", 
                                         "Percentile 3", "Percentile 4", 
                                         "Percentile 5", "Percentile 6", 
                                         "Percentile 7", "Percentile 8", 
                                         "Percentile 9", "Percentile 10")

#plot
agreement_stacked_barplot = 
agreement_plot_long%>%
  ggplot(aes(x = People_Percentile, y = value, fill = variable))+
  geom_col(position = position_stack(reverse = TRUE))+theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_manual(labels = c("Individual", "Common", "Unaccounted","Forest"),
    values=c("#E69F00", "#999933", "#D55E00","#117733")) + labs(fill = "Land tenure/cover", x = "Percentiles", y = "Proportion of Tenure")

agreement_stacked_barplot

```

#COMBINE THE DISTRICTS INFO FILE WITH SPATIAL DATA FOR FINAL MAPS

```{r message=FALSE, warning=FALSE, include=TRUE}

#first remove the districts which don't have a value for climate vulnerability from the larger districts file and potential extracted
districts= districts[!is.na(districts$Pp__M),]

districts_final = sp::merge(districts, districts_info[c("tenure_max","tenure_max_cat","People_Percentile","Poverty_Percentile", "Climate_Vul_Percentile", "Strassburg_Percentile", "People_Strassburg_Percent_Match", "Prop_Indiv", "Prop_Common", "Prop_Unaccounted", "Prop_Forest","Poverty_Strassburg_Percent_Match", "Climate_Strassburg_Percent_Match", "Aspirational_District", "People_Strassburg_Percentile_Matched", "Poverty_Strassburg_Percentile_Matched", "Climate_Strassburg_Percentile_Matched", "NAME_1", "NAME_2")], by.x = c("NAME_1","NAME_2"), by.y= c("NAME_1", "NAME_2"), duplicateGeoms = T)

writeOGR(districts_final, layer = "districts_final", dsn= "District-MPI-Climate-Pop-Merged-Biophys-Percentile-Plot.shp", driver = "ESRI Shapefile")

#also create a dataframe from the shapefile to use for analysis below 
districts_df_final <- as(districts_final, "data.frame")

write.csv(districts_df_final, "District-Climate-MPI-Biophys-Ranked-Agreement-Percentiles.csv")

```

## CHARACTERISTICS OF POPULATION IN HIGH PEOPLE_CENTRIC RESTORATION OPPORTUNITY AREAS

1. Number of land-owning and landless households in the district.

```{r pressure, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
