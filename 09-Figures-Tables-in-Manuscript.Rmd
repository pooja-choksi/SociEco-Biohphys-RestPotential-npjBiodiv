---
title: "People-centric restoration: Figures and tables in manuscript"
author: "Pooja Choksi"
date: '2022-06-27'
output: html_document
---

In this script, we use the district level land use, multidimensional poverty, climate vulnerability and population data along with new sources of data for question 4 of this study.  


```{r setup, include=FALSE}
library(ggplot2)
library(forcats)
library(dplyr)
library(qcc)
library(gridExtra)
library(viridis)
#get color blind friendly colors 
library(pals)
library(rgdal)

```


Read in all the data from previous scripts that we need for plots and tables.

```{r message = FALSE, warning=FALSE, include=TRUE}

#For all questions, we need this data
districts_info = read.csv("District-Climate-MPI-Biophys-Ranked.csv")

#list of aspirational districts from Phase 1
aspirational_districts = read.csv("Aspirational-Districts-Phase1.csv")

#district shapefile with info on the people-centric variables
districts = readOGR("C:\\Users\\pooja\\Documents\\GitHub\\Land-Tenure-Restoration-Potential\\Land-Tenure-Restoration-Potential\\Census2011-District-Shapefiles\\District-MPI-Climate-Pop-Merged-Biophys.shp")

```

#COMBINE ASPIRATIONAL DISTRICTS TO DISTRICTS_INFO

```{r message=FALSE, warning=FALSE, include=TRUE}

#Make a variable for the presence of aspirational district
aspirational_districts$Aspirational_District = "Aspirational_district"

#recode districts to match with the main dataset 
aspirational_districts = aspirational_districts%>%dplyr::mutate(District.name = recode(District.name, 
"West singhbhum" ="Pashchimi Singhbhum", 
"Chatttarpur" = "Chhatarpur",
"East nimar" = "East Nimar",
"Gadchiroli" = "Garhchiroli",
"Nuapara" = "Nuapada",
"Ferozepur" = "Firozpur",
"Dholpur" = "Dhaulpur",
"Virudhunagar" = "Virudunagar",
"Haridwar" = "Hardwar",
"Udham singh nagar" = "Udham Singh Nagar",
"Dakshin dinajpur" = "Dakshin Dinajpur"))

#combine with districts_info

#Combine aspiration districts with the main dataset
districts_info = merge(districts_info, aspirational_districts[c("District.name", "S.NO.", "Aspirational_District")], by.x = c("NAME_2", "NAME_1"), 
              by.y =c("District.name", "S.NO."), all.x=T)

```

## SYNERGIES AND TRADE-OFFS BETWEEN SEVERAL FACTORS

The chunk of code below creates a scatterplot where each district's biophysical potential and people-centric restoration opportunity scale is plotted. 

```{r message=FALSE, warning=FALSE, include=TRUE, echo= FALSE}
#All the land tenures together
#first categorize the three variables

#Remove the duplicates 
districts_info = districts_info [!duplicated(districts_info[c("NAME_1","NAME_2")]),]

districts_info$tenure_max  = apply(districts_info[c("Tt_C_", "Tt_I_", "Tt_F_")], 1, max)

districts_info = districts_info%>%mutate(tenure_max_cat = 
 case_when(tenure_max == Tt_I_ ~ "Individual",
           tenure_max == Tt_C_ ~ "Common",
           tenure_max == Tt_F_ ~ "Forest", 
           TRUE ~ "NA"))

#Strassburg potential v/s People-centric restoration potential
levels(districts_info$tenure_max_cat) = c("Forest", "Common", "Individual")

tenure_category = c("#999933","#117733", "#E69F00")

biophys_people_scale1 = ggplot(districts_info) + geom_jitter(data= districts_info, aes(x = Strassburg_Scaled_final, y= Pp__M, color = tenure_max_cat,),size = 3, alpha = 0.6)+theme_bw()+scale_color_manual(values = tenure_category)+ scale_y_continuous(name = "People-centric restoration opportunity")+ scale_x_continuous(name="Biophysical restoration potential")+ geom_vline(xintercept =0.74401004, linetype="dashed") + geom_hline(yintercept =0.6317055, linetype="dashed")+ labs(color ="Dominant land tenure")

#climate vulnerability v/s biophysical potential 
levels(districts_info$tenure_max_cat) = c("Forest", "Common", "Individual")

tenure_category = c("#999933","#117733", "#E69F00")

biophys_people_scale2 = ggplot(districts_info) + geom_jitter(data= districts_info, aes(x = Strassburg_Scaled_final, y= Clmt_vln_1, color= tenure_max_cat),size=3, alpha = 0.6)+theme_bw()+scale_color_manual(values = tenure_category)+ scale_y_continuous(limits = c(0,1), name = "Climate vulnerability")+ scale_x_continuous(limits =c(0,1), name="Biophysical restoration potential")+ geom_vline(xintercept =0.74401004, linetype="dashed") + geom_hline(yintercept = 0.5550122, linetype="dashed")+ labs(color = "Dominant land tenure", shape = "Dominant tenure regime")

biophys_people_scale2

#POverty v/s biophysical potential 

tenure_category = c("#999933","#117733", "#E69F00")

biophys_people_scale3 = ggplot(districts_info) + geom_jitter(data= districts_info, aes(x = Strassburg_Scaled_final, y= Lvn__, color= tenure_max_cat), size=3, alpha = 0.6)+theme_bw()+scale_color_manual(values = tenure_category)+ scale_y_continuous(limits = c(0,1), name = "Poverty (Living standards)")+ scale_x_continuous(limits =c(0,1), name="Biophysical restoration potential")+ geom_vline(xintercept =0.74401004, linetype="dashed") + geom_hline(yintercept = 0.7116883, linetype="dashed")+ labs(color = "Dominant land tenure", shape = "Dominant tenure regime")

biophys_people_scale3

#plot together
install.packages("ggpubr")
library(ggpubr)

ggarrange(biophys_people_scale2, biophys_people_scale3,  common.legend = TRUE, ncol =2, nrow=1)

```

#AGREEMENT BETWEEN THE DIFFERENT SCALES WITHIN DISTRICTS PERCENTILES 

This chunk of code uses the exact cut offs for the percentiles to see the synergy between districts

```{r}
#Percentiles for people-centric scale 
quantile(districts_info$Pp__M,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(People_Percentile_Upper = case_when(Pp__M <=0.4445172 ~ 10,
Pp__M<=0.5135141~ 20,
Pp__M<=0.5573356 ~ 30,
Pp__M<=0.6001708~ 40,
Pp__M<=0.6317055~ 50,
Pp__M<=0.6610663 ~ 60,
Pp__M<=0.6912787 ~ 70,
Pp__M<=0.7253923 ~ 80,
Pp__M<=0.7628635 ~ 90,
Pp__M<=0.9506494 ~ 100,
TRUE ~ 0))

#Percentiles for living standards of MPI 
quantile(districts_info$Lvn__,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(Poverty_Percentile_Upper = case_when(
Lvn__<=0.4620779 ~ 10,
Lvn__<=0.5870130 ~ 20,
Lvn__<=0.6389610 ~ 30,
Lvn__<=0.6727273 ~ 40,
Lvn__<=0.7116883 ~ 50,
Lvn__<=0.7361039 ~ 60,
Lvn__<=0.7696104 ~ 70,
Lvn__<=0.8000000 ~ 80,
Lvn__<=0.8522078 ~ 90,
Lvn__<=1.0000000 ~ 100,
TRUE ~ 0))

#Percentiles for climate vulnerability
quantile(districts_info$Clmt_vln_1,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(Climate_Vul_Percentile_Upper = case_when(Clmt_vln_1<=0.3447433 ~ 10,
Clmt_vln_1<=0.4058680 ~ 20,
Clmt_vln_1<=0.4523227 ~ 30,
Clmt_vln_1<=0.5012225~ 40,
Clmt_vln_1<=0.5550122~ 50,
Clmt_vln_1<=0.5941320 ~ 60,
Clmt_vln_1<=0.6413203 ~ 70,
Clmt_vln_1<=0.6894866 ~ 80,
Clmt_vln_1<=0.7579462 ~ 90,
Clmt_vln_1<=1.0000000 ~ 100,
TRUE ~ 0))

#Percentiles for Strassburg dataset
quantile(districts_info$Strassburg_Scaled_final,  probs = seq(0, 1,1/10))

districts_info = districts_info%>%mutate(Strassburg_Percentile_Upper = case_when(Strassburg_Scaled_final<=0.44012024 ~ 10,
Strassburg_Scaled_final<=0.55204775 ~ 20,
Strassburg_Scaled_final<=0.65949414 ~30,
Strassburg_Scaled_final<=0.70312745~ 40,
Strassburg_Scaled_final<=0.74401004~ 50,
Strassburg_Scaled_final<=0.77339286 ~ 60,
Strassburg_Scaled_final<=0.80372271 ~ 70,
Strassburg_Scaled_final<=0.83253145 ~ 80,
Strassburg_Scaled_final<=0.86876068 ~ 90,
Strassburg_Scaled_final<=0.9565341 ~ 100,
TRUE ~ 0))

#Agreement between People percentile and Strassburg
districts_info = districts_info%>%mutate(People_Strassburg_Agreement = case_when(People_Percentile_Upper >=100 & Strassburg_Percentile_Upper >= 100~ 100,
People_Percentile_Upper >= 90 & Strassburg_Percentile_Upper >=90~ 90,
People_Percentile_Upper >= 80 & Strassburg_Percentile_Upper >=80~ 80,
People_Percentile_Upper >= 70 & Strassburg_Percentile_Upper >=70~ 70,
People_Percentile_Upper >= 60 & Strassburg_Percentile_Upper >=60~ 60,
#People_Percentile_Upper >= 50 & Strassburg_Percentile_Upper >=50~ 50,
People_Percentile_Upper<= 50 & Strassburg_Percentile_Upper<= 50 ~ 1, 
TRUE ~ 0))

#Agreement between poverty and Strassburg
districts_info = districts_info%>%mutate(Poverty_Strassburg_Agreement = case_when(Poverty_Percentile_Upper >=100 & Strassburg_Percentile_Upper >= 100~ 100,
Poverty_Percentile_Upper >= 90 & Strassburg_Percentile_Upper >=90~ 90,
Poverty_Percentile_Upper >= 80 & Strassburg_Percentile_Upper >=80~ 80,
Poverty_Percentile_Upper >= 70 & Strassburg_Percentile_Upper >=70~ 70,
Poverty_Percentile_Upper >= 60 & Strassburg_Percentile_Upper >=60~ 60,
#Poverty_Percentile_Upper >= 50 & Strassburg_Percentile_Upper >=50~ 50,
Poverty_Percentile_Upper<= 50 & Strassburg_Percentile_Upper<= 50 ~ 1, 
TRUE ~ 0))

#Agreement between climate vulnerabiltiy and Strassburg
districts_info = districts_info%>%mutate(Climate_Vul_Strassburg_Agreement = case_when(Climate_Vul_Percentile_Upper >=100 & Strassburg_Percentile_Upper >= 100~ 100,
Climate_Vul_Percentile_Upper >= 90 & Strassburg_Percentile_Upper >=90~ 90,
Climate_Vul_Percentile_Upper >= 80 & Strassburg_Percentile_Upper >=80~ 80,
Climate_Vul_Percentile_Upper >= 70 & Strassburg_Percentile_Upper >=70~ 70,
Climate_Vul_Percentile_Upper >= 60 & Strassburg_Percentile_Upper >=60~ 60,
#Climate_Vul_Percentile_Upper >= 50 & Strassburg_Percentile_Upper >=50~ 50,
Climate_Vul_Percentile_Upper<= 50 & Strassburg_Percentile_Upper<= 50 ~ 1, 
TRUE ~ 0))

```

#SUPP INFO TABLES AGREEMENT AND DISAGREEMENT IN DISTRICTS

This chunk of code is used to produce tables SI 

```{r message=TRUE, warning=TRUE, include=FALSE}

#1. People-centric and Strassburg agreement percentiles 
agreement_people_strassburg = districts_info%>%group_by(People_Strassburg_Agreement)%>%count()

#2. Poverty and Strassburg agreement percentiles
agreement_poverty_strassburg = districts_info%>%group_by(Poverty_Strassburg_Agreement)%>%count()

#3. Climate vulnerability Strassburg agreement percentiles
agreement_climate_strassburg = districts_info%>%group_by(Climate_Vul_Strassburg_Agreement)%>%count()

```

#REPORT THE DISTRICTS IN THE TOP AND BOTTOM PERCENTILES AND QUANTILES 

This chunk of code is used to generate the numbers reported in the main text of the paper. Refer to each table created in this chunk of code to compare with the numbers reported in paper

```{r message = FALSE, warning=FALSE, include =TRUE}

#top percentile (higher percentile is higher priority)
percentile_100_people = districts_info%>%filter(People_Percentile_Upper == "100")
percentile_100_states = percentile_100_people%>%group_by(NAME_1)%>%count()
  
#top percentile of poverty 
percentile_100_poverty = districts_info%>%filter(Poverty_Percentile_Upper == "100")
percentile_100_poverty_states = percentile_100_poverty%>%group_by(NAME_1)%>%count()

#top percentile of climate vulnerability
percentile_100_climate = districts_info%>%filter(Climate_Vul_Percentile_Upper == "100")
percentile_100_climate_states = percentile_100_climate%>%group_by(NAME_1)%>%count()

```

#PLOT OF PROPORTION OF LAND TENURES WITHIN THE AGREEMENT DISTRICTS

Within districts which have agreement across percentiles, this plot shows the distribution of land tenure

```{r message=FALSE, warning=FALSE, include=TRUE}
#Filter out the agreement districts 

#1. People-centric and Strassburg agreement percentiles 
agreement = districts_info%>%filter(People_Strassburg_Agreement>1)

agreement$People_Percentile = as.factor(agreement$People_Percentile)

options(scipen = 999)

#Proportion of land available in each land tenure
agreement_plot = agreement%>%dplyr::group_by(People_Percentile)%>%
  dplyr::summarise(total = n(),
                   total_indiv = sum(Tt_I_), 
                   total_forest = sum(Tt_F_),
                   total_unaccounted = sum(Tt_U_),
                   total_common = sum(Tt_C_))

agreement_plot = agreement_plot%>%mutate(Prop_Indiv = (total_indiv/(total_indiv+total_common+total_forest+total_unaccounted))*100,

Prop_Common = (total_common/(total_indiv+total_common+total_forest+total_unaccounted))*100,

Prop_Unaccounted =(total_unaccounted/(total_indiv+total_common+total_forest+total_unaccounted))*100,

Prop_Forest = (total_forest/(total_indiv+total_common+total_forest+total_unaccounted))*100)

#reshape data for plotting
install.packages("reshape2")
library(reshape2)

agreement_plot_long = agreement_plot[, -c(2:6)]
agreement_plot_long = reshape2::melt(agreement_plot_long, id.vars = "People_Percentile")

#define the levels to plot 
levels(agreement_plot_long$People_Percentile) = c("Percentile 1", "Percentile 2", 
                                         "Percentile 3", "Percentile 4", 
                                         "Percentile 5", "Percentile 6", 
                                         "Percentile 7", "Percentile 8", 
                                         "Percentile 9", "Percentile 10")

#plot
agreement_stacked_barplot = 
agreement_plot_long%>%
  ggplot(aes(x = People_Percentile, y = value, fill = variable))+
  geom_col(position = position_stack(reverse = TRUE))+theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_manual(labels = c("Individual", "Common", "Unaccounted","Forest"),
    values=c("#E69F00", "#999933", "#D55E00","#117733")) + labs(fill = "Land tenure/cover", x = "Percentiles", y = "Proportion of Tenure") + scale_x_discrete(name = "Percentiles", labels = c(">50%", ">60%", ">70%", ">80%", ">90%"))

agreement_stacked_barplot

```

#PLOT OF THE DISTRIBUTION OF EACH LAND TENURE IN THE TOP DISTRICTS AND REPORT % of LAND TENURE IN TOP DISTRICTS

This chunk of code was used to create Fig_ and the values reported in the paper.

```{r message=FALSE, warning=FALSE, include=TRUE}

top_districts = districts_info%>%filter(People_Percentile_Upper ==100)

top_districts = top_districts%>%select("NAME_2", "NAME_1", "Tt_I_",
                                        "Tt_C_", "Tt_F_", "Tt_U_")

#wide to long
top_district_long = reshape(top_districts, direction='long', varying=c('Tt_I_', 'Tt_C_', 'Tt_F_', 'Tt_U_'), timevar= 'Land_Tenure', times=c('Individual', 'Common_NonForest', 'Forest', 'Unaccounted'),
v.names= 'Total_Hectares',
idvar=c('NAME_2', 'NAME_1'))

#plot of the distribution of land tenure in top districts
tenure_topdistricts = ggplot()+geom_histogram(data= top_districts, aes(x=Total_Forest_sum), fill ="#117733", alpha=0.5, binwidth = 300000)+geom_histogram(data = top_districts, aes(x=Total_Common_sum), fill = "#999933", alpha =0.5, binwidth = 300000)+ geom_histogram(data = top_districts, aes(x= Total_Indiv_sum), fill = "#E69F00", alpha= 0.5, binwidth = 300000)+ theme_classic()+ theme(axis.text.x = element_text(angle = 45, hjust = 1))+ labs(x = "Total number of hectares", y = "Freqeuncy")

tenure_topdistricts

#reporting % of land tenure in each district 
tenure_topdistricts_report = top_district_long%>%group_by(Land_Tenure)%>%summarise(hectares_category = sum(Total_Hectares))

tenure_topdistricts_report= tenure_topdistricts_report%>%mutate(tenure_total = colSums(tenure_topdistricts_report[,-1])) 

tenure_topdistricts_report = tenure_topdistricts_report%>%mutate(tenure_prop = (hectares_category/tenure_total)*100)

#how many districts have other tenures as max?
top_districts$tenure_max  = apply(top_districts[c("Tt_C_", "Tt_I_", "Tt_F_")], 1, max)

top_districts_tenure = top_districts%>%mutate(tenure_max_cat = 
 case_when(tenure_max == Tt_I_ ~ "Individual",
           tenure_max == Tt_C_ ~ "Common",
           tenure_max == Tt_F_ ~ "Forest", 
           TRUE ~ "NA"))

#see DF to report the distribution in main manuscript

```

#COMBINE THE DISTRICTS INFO FILE WITH SPATIAL DATA FOR FINAL MAPS

```{r message=FALSE, warning=FALSE,include=TRUE}

#first remove the districts which don't have a value for climate vulnerability from the larger districts file and potential extracted
districts= districts[!is.na(districts$Pp__M),]

districts_final = sp::merge(districts, districts_info[c("Strassburg_India_Clipped", "Strassburg_Scaled_final", "Aspirational_District", "tenure_max", "tenure_max_cat", "People_Percentile_Upper", "Poverty_Percentile_Upper", "Climate_Vul_Percentile_Upper", "Strassburg_Percentile_Upper", "People_Strassburg_Percent_Match", "People_Strassburg_Agreement", "Poverty_Strassburg_Agreement", "Climate_Vul_Strassburg_Agreement", "NAME_1", "NAME_2")], by.x = c("NAME_1","NAME_2"), by.y= c("NAME_1", "NAME_2"), duplicateGeoms = T)

writeOGR(districts_final, layer = "districts_final", dsn= "District-MPI-Climate-Pop-Merged-Biophys-Percentile-Plot.shp", driver = "ESRI Shapefile")

#also create a dataframe from the shapefile to use for analysis below 
districts_df_final <- as(districts_final, "data.frame")

write.csv(districts_df_final, "District-Climate-MPI-Biophys-Ranked-Agreement-Percentiles.csv")

```

## CHARACTERISTICS OF POPULATION IN HIGH PEOPLE_CENTRIC RESTORATION OPPORTUNITY AREAS

1. Number of land-owning and landless households in the district.

```{r pressure, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
